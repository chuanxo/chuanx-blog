{{- /* Giscus 评论系统集成 */ -}}
{{- /* 仅当文章评论启用时显示 */ -}}
{{- if (and (.Params.comments) (not (eq .Params.comments false))) -}}
<div class="giscus-comments">
  <script src="https://giscus.app/client.js"
          data-repo="chuanxo/chuanx-blog"
          data-repo-id="R_kgDOOO4Ybg"
          data-category="General"
          data-category-id="DIC_kwDOOO4Ybs4Cn7KD"
          data-mapping="pathname"
          data-strict="0"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="bottom"
          data-theme="preferred_color_scheme"
          data-lang="zh-CN"
          data-loading="lazy"
          crossorigin="anonymous"
          async>
  </script>
</div>

<style>
  .giscus-comments {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border);
  }
</style>

{{- /* 主题切换支持 */ -}}
<script>
  // 同步 Giscus 主题与 PaperMod 主题
  function setGiscusTheme() {
    const theme = document.documentElement.getAttribute('data-theme') || 'light';
    const giscusTheme = theme === 'dark' ? 'dark' : 'light';

    const iframe = document.querySelector('iframe.giscus-frame');
    if (iframe) {
      iframe.contentWindow.postMessage(
        { giscus: { setConfig: { theme: giscusTheme } } },
        'https://giscus.app'
      );
    }
  }

  // 监听主题变化
  const observer = new MutationObserver(setGiscusTheme);
  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['data-theme']
  });

  // Giscus 加载时设置初始主题
  window.addEventListener('message', (event) => {
    if (event.origin === 'https://giscus.app') {
      setGiscusTheme();
    }
  });
</script>
{{- end -}}
